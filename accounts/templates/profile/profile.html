{% extends "account/base.html" %}
{% load static %}

{% block content %}
<style>
/* ================== BUTTON ================== */
.follow-btn {
    padding: 6px 16px;
    border: none;
    border-radius: 4px;
    background: #0095f6;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
}
.follow-btn:hover { background: #1877f2; }

.unfollow-btn {
    padding: 6px 16px;
    border: 1px solid #dbdbdb;
    border-radius: 4px;
    background: transparent;
    color: #262626;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
}
.unfollow-btn:hover { background: #efefef; }

.edit-profile-btn, .message-btn {
    padding: 6px 16px;
    border: 1px solid #dbdbdb;
    border-radius: 4px;
    background: transparent;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
}
.options-btn {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    padding: 0 10px;
}

/* ================== RESET ================== */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; }

/* ================== PROFILE ================== */
.profile-container { max-width: 935px; margin: 0 auto; padding: 30px 20px 60px; display: flex; flex-direction: column; }
.profile-header { display: flex; margin-bottom: 44px; padding: 0 20px; flex-wrap: wrap; }
.profile-avatar-wrapper { flex: 0 0 auto; display: flex; justify-content: center; margin-right: 30px; margin-bottom: 20px; }
.profile-avatar { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 1px solid #dbdbdb; background-color: #9e9e9e; }

.profile-info { flex: 1; min-width: 300px; display: flex; flex-direction: column; }
.profile-top { display: flex; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
.profile-top h2 { font-size: 28px; font-weight: 300; margin-right: 20px; margin-bottom: 10px; }
.action-buttons { display: flex; gap: 10px; margin-bottom: 10px; }

.profile-stats { display: flex; margin-bottom: 20px; gap: 40px; flex-wrap: wrap; }
.profile-stats span { font-size: 16px; white-space: nowrap; }
.profile-stats b { font-weight: 600; }

.profile-bio { font-size: 16px; }
.profile-name { font-weight: 600; margin-bottom: 5px; }

/* ================== TABS ================== */
.profile-tabs { display: flex; justify-content: center; border-top: 1px solid #dbdbdb; width: 100%; }
.tab-item { display: flex; align-items: center; gap: 6px; font-size: 12px; text-transform: uppercase; cursor: pointer; color: #8e8e8e; font-weight: 500; padding: 15px 0; margin: 0 30px; border-top: 1px solid transparent; background: none; border: none; white-space: nowrap; }
.tab-item.active { color: #262626; border-top: 1px solid #262626; }
.tab-item i { font-size: 16px; }

/* ================== POSTS ================== */
.tab-content { width: 100%; display: flex; flex-direction: column; }
.post-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 28px; transition: opacity 0.3s ease; }
.post-item { position: relative; overflow: hidden; aspect-ratio: 1/1; background-color: #fafafa; border-radius: 4px; cursor: pointer; }
.post-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
.post-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
.post-item:hover .post-overlay { opacity: 1; }
.post-stats { display: flex; gap: 20px; color: white; font-weight: 600; }
.post-stats span { display: flex; align-items: center; gap: 5px; }

/* ================== EMPTY STATE ================== */
.no-posts { grid-column: 1 / -1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 100px 20px; color: #8e8e8e; text-align: center; }
.no-posts i { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
.no-posts p { font-size: 18px; margin: 0; }

/* ================== RESPONSIVE ================== */
@media (max-width: 768px) {
    .profile-header { flex-direction: column; align-items: center; text-align: center; }
    .profile-avatar-wrapper { margin-right: 0; margin-bottom: 20px; }
    .profile-info { align-items: center; }
    .profile-top { flex-direction: column; align-items: center; gap: 15px; }
    .profile-stats { justify-content: center; gap: 20px; }
    .post-grid { gap: 3px; }
    .profile-container { padding: 0 0 60px; }
    .tab-item { margin: 0 10px; }
}

/* ================== ANIMATION ================== */
.fade-in { animation: fadeIn 0.5s forwards; }
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
</style>

<div class="profile-container">
    <!-- Header -->
    <div class="profile-header">
        <div class="profile-avatar-wrapper">
            <img src="{{ profile_user.profile.avatar.url }}" alt="{{ profile_user.username }}" class="profile-avatar">
        </div>

        <div class="profile-info">
            <div class="profile-top">
                <h2>{{ profile_user.username }}</h2>
                <div class="action-buttons">
                    {% if user.username != profile_user.username %}
                        <button class="{% if is_following %}unfollow-btn{% else %}follow-btn{% endif %}" onclick="followUser('{{ profile_user.username }}')">
                            {% if is_following %}ƒêang theo d√µi{% else %}Theo d√µi{% endif %}
                        </button>
                        <button class="message-btn">Nh·∫Øn tin</button>
                    {% else %}
                        <button class="edit-profile-btn">Ch·ªânh s·ª≠a trang c√° nh√¢n</button>
                    {% endif %}
                </div>
                <button class="options-btn">‚ãØ</button>
            </div>

            <div class="profile-stats">
                <span><b>{{ posts_count }}</b> b√†i vi·∫øt</span>
                <span><b>{{ followers_count }}</b> ng∆∞·ªùi theo d√µi</span>
                <span><b>{{ following_count }}</b> ƒëang theo d√µi</span>
            </div>

            <div class="profile-bio">
                <div class="profile-name">{{ user.get_full_name }}</div>
                <p>‚ú® Chia s·∫ª nh·ªØng kho·∫£nh kh·∫Øc ƒë·∫πp trong cu·ªôc s·ªëng</p>
                <p>üìç H√† N·ªôi, Vi·ªát Nam</p>
                <a href="#" style="color: #00376b;">www.example.com</a>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="profile-tabs">
        <button class="tab-item active" data-tab="posts"><i class="fas fa-table-cells"></i><span>B√†i vi·∫øt</span></button>
        <button class="tab-item" data-tab="saved"><i class="far fa-bookmark"></i><span>ƒê√£ l∆∞u</span></button>
    </div>

    <!-- Tab content -->
    <div class="tab-content">
        <!-- Posts -->
      <div id="posts" class="post-grid fade-in">
    {% for post in posts %}
    <div class="post-item" onclick="openPostModal({{ post.id }})">
        {% with first_media=post.medias.first %}
            {% if first_media %}
                {% if first_media.media_type == "image" %}
                    <img src="{{ first_media.file.url }}" alt="Post image">
                {% elif first_media.media_type == "video" %}
                    <video muted playsinline class="post-video">
                        <source src="{{ first_media.file.url }}" type="video/mp4">
                    </video>
                {% endif %}
            {% else %}
                <div class="no-media">Kh√¥ng c√≥ media</div>
            {% endif %}
        {% endwith %}

        <!-- overlay khi hover -->
        <div class="post-overlay">
            <div class="post-stats">
                <span><i class="fas fa-heart"></i> {{ post.hearts.count }}</span>
                <span><i class="fas fa-comment"></i> {{ post.comments.count }}</span>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="no-posts">
        <i class="fas fa-camera"></i>
        <p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>
    </div>
    {% endfor %}
</div>

        <!-- Saved -->
        <div id="savedPosts" class="post-grid" style="display:none;">
            {% for saved_post in saved_posts %}
            <div class="post-item">
                <img src="{{ saved_post.image.url }}" alt="Saved image">
                <div class="post-overlay">
                    <div class="post-stats">
                        <span><i class="fas fa-heart"></i> {{ saved_post.likes_count }}</span>
                        <span><i class="fas fa-comment"></i> {{ saved_post.comments_count }}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-posts">
                <i class="far fa-bookmark"></i>
                <p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o ƒë∆∞·ª£c l∆∞u</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tabItems = document.querySelectorAll('.tab-item');
    const postsGrid = document.getElementById('posts');
    const savedPostsGrid = document.getElementById('savedPosts');

    tabItems.forEach(tab => {
        tab.addEventListener('click', function() {
            tabItems.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            postsGrid.style.display = 'none';
            savedPostsGrid.style.display = 'none';
            const target = this.dataset.tab;
            const grid = target === 'posts' ? postsGrid : savedPostsGrid;
            setTimeout(() => {
                grid.style.display = 'grid';
                grid.classList.remove('fade-in');
                void grid.offsetWidth;
                grid.classList.add('fade-in');
            }, 50);
        });
    });
});

function followUser(username) {
    const csrftoken = getCookie('csrftoken');
    const button = event.currentTarget;

    fetch(`/follow/${username}/`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrftoken }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'followed') {
            button.textContent = 'ƒêang theo d√µi';
            button.className = 'unfollow-btn';
        } else if (data.status === 'unfollowed') {
            button.textContent = 'Theo d√µi';
            button.className = 'follow-btn';
        }
        document.querySelector('.profile-stats span:nth-child(2) b').textContent = data.followers_count;
    })
    .catch(err => console.error(err));
}
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length+1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
